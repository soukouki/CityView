services:
  # --- Infrastructure Layer ---
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_DB: app
    volumes:
      - ./volume-db:/var/lib/postgresql/data
      - ./db/init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  storage:
    image: nginx:alpine
    command: ["sh", "-c", "mkdir -p /data/images/screenshots && mkdir -p /data/images/rawtiles && mkdir -p /data/images/tiles && chown -R nginx:nginx /data && nginx -g 'daemon off;'"]
    volumes:
      - ./volume-storage:/data
      - ./storage/webdav.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # --- Application Layer ---
  backend:
    build: ./backend
    environment:
      DATABASE_URL: postgres://postgres@db:5432/app
      PREFECT_API_URL: http://prefect-server:4200/api
      STORAGE_URL: http://storage
    ports:
      - "8000:8000" # メイン
      - "8001:8001" # 管理画面
      - "8002:8002" # Prefect Agent連携用内部API
    volumes:
      - ./volume-backend-logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      prefect-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # --- Prefect Layer ---
  prefect-server:
    image: prefecthq/prefect:2.16.0-python3.11
    command: prefect server start --host 0.0.0.0
    environment:
      PREFECT_SERVER_API_HOST: 0.0.0.0
      PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://postgres:postgres@db:5432/prefect
      PREFECT_API_URL: http://prefect-server:4200/api
    ports:
      - "8003:4200"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:4200/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  prefect-worker:
    build: ./prefect
    command: prefect worker start --pool default-agent-pool
    environment:
      PREFECT_LOGGING_LOG_PRINTS: "true"
      PREFECT_API_URL: http://prefect-server:4200/api
      SERVICE_CAPTURE_URL: http://service-capture:5000
      SERVICE_ESTIMATE_URL: http://service-estimate:5001
      SERVICE_TILE_CUT_URL: http://service-tile-cut:5002
      SERVICE_TILE_MERGE_URL: http://service-tile-merge:5003
      SERVICE_TILE_COMPRESS_URL: http://service-tile-compress:5004
      BACKEND_INTERNAL_URL: http://backend:8002
      STORAGE_URL: http://storage
      TZ: ${TZ:-Asia/Tokyo}
      ADJUSTED_PAKSIZE: ${ADJUSTED_PAKSIZE}
      TILE_SIZE: ${TILE_SIZE}
      DELTA: ${DELTA}
      MAP_TILES_X: ${MAP_TILES_X}
      MAP_TILES_Y: ${MAP_TILES_Y}
      IMAGE_WIDTH: ${IMAGE_WIDTH}
      IMAGE_HEIGHT: ${IMAGE_HEIGHT}
      IMAGE_MARGIN_WIDTH: ${IMAGE_MARGIN_WIDTH}
      IMAGE_MARGIN_HEIGHT: ${IMAGE_MARGIN_HEIGHT}
      IMAGE_EFFECTIVE_WIDTH: ${IMAGE_EFFECTIVE_WIDTH}
      IMAGE_EFFECTIVE_HEIGHT: ${IMAGE_EFFECTIVE_HEIGHT}
      TILE_QUALITY_MAX_ZOOM: ${TILE_QUALITY_MAX_ZOOM}
      TILE_QUALITY_OTHER: ${TILE_QUALITY_OTHER}
      ZOOM_LEVEL: ${ZOOM_LEVEL}
      TILE_GROUP_SIZE: ${TILE_GROUP_SIZE}
      SAVE_DATA_NAME: ${SAVE_DATA_NAME}
    volumes:
      - ./prefect:/opt/prefect/flows:ro
    depends_on:
      prefect-server:
        condition: service_healthy
      prefect-init:
        condition: service_completed_successfully
    deploy:
      replicas: 2
    restart: unless-stopped

  # 初期化専用コンテナ（1回だけ実行）
  prefect-init:
    build: ./prefect
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
    volumes:
      - ./prefect:/opt/prefect/flows:ro
    depends_on:
      prefect-server:
        condition: service_healthy
    command: >
      sh -c "
      echo 'Waiting for Prefect API...' &&
      sleep 5 &&
      echo 'Deleting old work pool if exists...' &&
      prefect work-pool delete default-agent-pool || true &&
      echo 'Creating new work pool...' &&
      prefect work-pool create default-agent-pool --type process &&
      echo 'Deploying flows...' &&
      cd /opt/prefect/flows &&
      prefect deploy --all &&
      echo 'Verifying deployment...' &&
      prefect deployment inspect 'create_tiles/create-tiles-default' &&
      echo 'Initialization complete!'
      "
    restart: "no"

  # --- Processing Service Layer ---
  service-capture:
    build: ./service-capture
    environment:
      STORAGE_URL: http://storage
      SIMUTRANS_EXECUTABLE: ${SIMUTRANS_EXECUTABLE}
      PAKSET_NAME: ${PAKSET_NAME}
      CAPTURE_SCREEN_WIDTH: ${CAPTURE_WIDTH}
      CAPTURE_SCREEN_HEIGHT: ${CAPTURE_HEIGHT}
      CAPTURE_CROP_WIDTH: ${IMAGE_WIDTH}
      CAPTURE_CROP_HEIGHT: ${IMAGE_HEIGHT}
      CAPTURE_CROP_OFFSET_X: ${CROP_OFFSET_X}
      CAPTURE_CROP_OFFSET_Y: ${CROP_OFFSET_Y}
      CAPTURE_REDRAW_WAIT_SECONDS: 1.0 # ズームレベルが低い場合は描画に時間がかかることがあるため長めに設定すること
      CAPTURE_SCROT_SETTLE_SECONDS: 0.1 # scrotがフレームバッファを読み込むまでの待機時間
      CAPTURE_SCROT_TIMEOUT_SECONDS: 30
      CAPTURE_CROP_TIMEOUT_SECONDS: 30
      CAPTURE_UPLOAD_TIMEOUT_SECONDS: 30
      CAPTURE_WORKER_THREADS: 4 # スクショ撮影・クリップ・アップロードを並列化するためのスレッド数
      CAPTURE_TTL_SECONDS: 300 # GAME_CAPTURE_TIMEOUT_SECONDSより長く設定すること
      GAME_BOOT_TIMEOUT_SECONDS: 300 # 大規模マップの場合は起動に時間がかかることがあるため長めに設定すること
      GAME_BOOT_POLL_INTERVAL_SECONDS: 5
      GAME_BOOT_CHECK_X: 256 # この座標が黒いかどうかで起動完了を判定する
      GAME_BOOT_CHECK_Y: 256
    volumes:
      - ./volume-storage:/data
      - ./volume-bin:/app/bin
      - ./volume-save:/root/simutrans/save
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      replicas: 2
    restart: unless-stopped

  service-estimate:
    build: ./service-estimate
    environment:
      STORAGE_URL: http://storage
      IMAGE_MARGIN_WIDTH: ${IMAGE_MARGIN_WIDTH}
      IMAGE_MARGIN_HEIGHT: ${IMAGE_MARGIN_HEIGHT}
      IMAGE_WIDTH: ${IMAGE_WIDTH}
      IMAGE_HEIGHT: ${IMAGE_HEIGHT}
    volumes:
      - ./volume-storage:/data
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      replicas: 2
    restart: unless-stopped

  service-tile-cut:
    build: ./service-tile-cut
    environment:
      STORAGE_URL: http://storage
      TILE_SIZE: ${TILE_SIZE}
    volumes:
      - ./volume-storage:/data
    deploy:
      replicas: 4
    restart: unless-stopped

  service-tile-merge:
    build: ./service-tile-merge
    environment:
      STORAGE_URL: http://storage
      TILE_SIZE: ${TILE_SIZE}
    volumes:
      - ./volume-storage:/data
    deploy:
      replicas: 2
    restart: unless-stopped

  service-tile-compress:
    build: ./service-tile-compress
    environment:
      STORAGE_URL: http://storage
    volumes:
      - ./volume-storage:/data
    deploy:
      replicas: 2
    restart: unless-stopped
