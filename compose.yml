services:
  # --- Infrastructure Layer ---
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_DB: app
    volumes:
      - ./volume-db:/var/lib/postgresql/data
      - ./db/init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  storage:
    image: nginx:alpine
    command: >
      sh -c "
      mkdir -p /data/images/screenshots &&
      mkdir -p /data/images/rawtiles &&
      mkdir -p /data/images/tiles &&
      mkdir -p /data/images/panels &&
      chown -R nginx:nginx /data &&
      nginx -g 'daemon off;'
      "
    volumes:
      - ./volume-storage:/data
      - ./storage/webdav.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # --- Application Layer ---
  backend:
    build: ./backend
    environment:
      DATABASE_URL: postgres://postgres@db:5432/app
      PREFECT_API_URL: http://prefect-server:4200/api
      STORAGE_URL: http://storage
      TZ: ${TZ:-Asia/Tokyo}
    ports:
      - "8000:8000" # メイン
      - "8001:8001" # 管理画面
      - "8002:8002" # Prefect Agent連携用内部API
    depends_on:
      db:
        condition: service_healthy
      prefect-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - ./volume-bin:/app/bin
      - ./backend/public:/app/public:ro
      - ./backend/admin:/app/admin:ro
    restart: unless-stopped

  # --- Prefect Layer ---
  prefect-server:
    image: prefecthq/prefect:3.6-python3.11
    command: prefect server start --host 0.0.0.0
    environment:
      PREFECT_UI_API_URL: /api
      PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://postgres:postgres@db:5432/prefect
      SERVICE_CAPTURE_REPLICAS: ${SERVICE_CAPTURE_REPLICAS}
      SERVICE_CAPTURE_WORKERS_PER_REPLICA: ${SERVICE_CAPTURE_WORKERS_PER_REPLICA}
      SERVICE_ESTIMATE_REPLICAS: ${SERVICE_ESTIMATE_REPLICAS}
      SERVICE_TILE_CUT_REPLICAS: ${SERVICE_TILE_CUT_REPLICAS}
      SERVICE_TILE_MERGE_REPLICAS: ${SERVICE_TILE_MERGE_REPLICAS}
      SERVICE_TILE_COMPRESS_REPLICAS: ${SERVICE_TILE_COMPRESS_REPLICAS}
      SERVICE_CREATE_PANEL_REPLICAS: ${SERVICE_CREATE_PANEL_REPLICAS}
    ports:
      - "4200:4200"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:4200/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  prefect-worker:
    build: ./prefect
    command: prefect worker start --pool default-agent-pool
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
      SERVICE_CAPTURE_URL: http://service-capture:5000
      SERVICE_ESTIMATE_URL: http://service-estimate:5001
      SERVICE_TILE_CUT_URL: http://service-tile-cut:5002
      SERVICE_TILE_MERGE_URL: http://service-tile-merge:5003
      SERVICE_TILE_COMPRESS_URL: http://service-tile-compress:5004
      SERVICE_CREATE_PANEL_URL: http://service-create-panel:5005
      BACKEND_INTERNAL_URL: http://backend:8002
      STORAGE_URL: http://storage
      TZ: ${TZ:-Asia/Tokyo}
      TILE_SIZE: ${TILE_SIZE}
    volumes:
      - ./prefect:/opt/prefect/flows:ro
    depends_on:
      prefect-server:
        condition: service_healthy
    restart: unless-stopped

  # 初期化専用コンテナ（1回だけ実行）
  prefect-init:
    build: ./prefect
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
    volumes:
      - ./prefect:/opt/prefect/flows:ro
    depends_on:
      prefect-server:
        condition: service_healthy
    command: >
      sh -c "
      echo 'Waiting for Prefect API...' &&
      sleep 5 &&
      echo 'Deleting old work pool if exists...' &&
      prefect work-pool delete default-agent-pool || true &&
      echo 'Creating new work pool with concurrency limit...' &&
      prefect work-pool create default-agent-pool --type process --set-as-default  &&
      echo 'Setting work pool concurrency limit to 1...' &&
      prefect work-pool set-concurrency-limit default-agent-pool 1 &&
      echo 'Creating global concurrency limit...' &&
      prefect concurrency-limit create create-tiles-lock 1 || true &&
      echo 'Creating work queue for create-tiles...' &&
      prefect work-queue create create-tiles-queue --pool default-agent-pool || true &&
      echo 'Deploying flows...' &&
      cd /opt/prefect/flows &&
      prefect deploy --all &&
      echo 'Verifying deployment...' &&
      prefect deployment inspect 'create_tiles/create-tiles' &&
      echo 'Initialization complete!'
      "
    restart: "no"

  # --- Processing Service Layer ---
  service-capture:
    build: ./service-capture
    environment:
      STORAGE_URL: http://storage
      CAPTURE_SCROT_SETTLE_SECONDS: 0.1 # scrotがフレームバッファを読み込むまでの待機時間
      CAPTURE_SCROT_TIMEOUT_SECONDS: 30
      CAPTURE_CROP_TIMEOUT_SECONDS: 30
      CAPTURE_UPLOAD_TIMEOUT_SECONDS: 30
      CAPTURE_WORKER_THREADS: ${SERVICE_CAPTURE_WORKERS_PER_REPLICA} # スクショ撮影・クリップ・アップロードを並列化するためのスレッド数
      CAPTURE_TTL_SECONDS: 300 # GAME_CAPTURE_TIMEOUT_SECONDSより長く設定すること
      GAME_BOOT_TIMEOUT_SECONDS: 300 # 大規模マップの場合は起動に時間がかかることがあるため長めに設定すること
      GAME_BOOT_POLL_INTERVAL_SECONDS: 5
      GAME_BOOT_CHECK_X: 256 # この座標が黒いかどうかで起動完了を判定する
      GAME_BOOT_CHECK_Y: 256
    volumes:
      - ./volume-bin:/app/bin
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      replicas: ${SERVICE_CAPTURE_REPLICAS}
    restart: unless-stopped

  service-estimate:
    build: ./service-estimate
    environment:
      STORAGE_URL: http://storage
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      replicas: ${SERVICE_ESTIMATE_REPLICAS}
    restart: unless-stopped

  service-tile-cut:
    build: ./service-tile-cut
    environment:
      STORAGE_URL: http://storage
      TILE_SIZE: ${TILE_SIZE}
    deploy:
      replicas: ${SERVICE_TILE_CUT_REPLICAS}
    restart: unless-stopped

  service-tile-merge:
    build: ./service-tile-merge
    environment:
      STORAGE_URL: http://storage
      TILE_SIZE: ${TILE_SIZE}
    deploy:
      replicas: ${SERVICE_TILE_MERGE_REPLICAS}
    restart: unless-stopped

  service-tile-compress:
    build: ./service-tile-compress
    environment:
      STORAGE_URL: http://storage
    deploy:
      replicas: ${SERVICE_TILE_COMPRESS_REPLICAS}
    restart: unless-stopped

  service-create-panel:
    build: ./service-create-panel
    environment:
      STORAGE_URL: http://storage
      TILE_SIZE: ${TILE_SIZE}
    deploy:
      replicas: ${SERVICE_CREATE_PANEL_REPLICAS}
    restart: unless-stopped

  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
