
# 画像について

## Simutransのタイルについて

ひし形のタイル。

前提条件
- pakサイズ128
- 最大ズーム

サイズ
- 縦128ピクセル
- 横256ピクセル

つまり、ひし形を2倍に拡大して表示されている。

## スクリーンショット撮影について

要求
- 縦128横256の整数倍に、さらに周囲に十分な余白を持つ必要がある。
- 画面上下のメニューバー、カーソルなどが映らないように、画面サイズは更に大きくし、クリッピングをする必要がある。
- pakサイズが64の場合は撮影の間隔を倍にしても良い。

UI要素除去用の余裕(後のスクショ座標計算には関係ない)
- $h + 128$
  - 上のメニューが64px、下のフッターが32pxと仮定して、少し余裕を持って+128pxした。
- $w + 512$
  - カーソルの退避を考えると、左右に256px以上欲しく、中央は合わせたいと思うと+512pxにする必要がある。

## Simutransタイルとスクリーンショットタイルの関係

タイルのサイズは縦128横256である。

タイル軸とスクショ軸があり、軸がズレていて原点も異なる。
**タイルの軸の向きとスクショの軸の向きはまったく異なり、大きくズレている**。

変数
- スクショのサイズ: $W, H$
  - Wは256の倍数、Hは128の倍数である必要がある。
  - 簡単にするために、$W=2H$と決め打つ
- スクショの余白部分(スクショ座標換算、1辺あたり、外数): $w, h$
  - 0 =(糊代)= h =(有効範囲)= h+H =(糊代)= 2h+H
  - 0 =(糊代)= w =(有効範囲)= w+W =(糊代)= 2w+W
  - 簡単にするために、$w=2h$と決め打つ

関係式(タイル座標x,yからスクショ座標X,Yを求める)
$$
\begin{align*}
X &= 256(x-y) + \dfrac{W}{2} + w \\
Y &= 128(x+y) + \dfrac{H}{2} + h \\
\end{align*}
$$

- 一番上のタイルを中心にして撮ったスクショ(以下「源スクショ」)の左上(以下「スクショ原点」)
  - タイル: $(-\dfrac{W/2 + w}{256}, 0)$
    - W:H = 256:128 = 2:1 より、その関係を維持する分、タイルのy座標は0になる。
  - スクショ: $(0, 0)$
- 源スクショの有効部分の左上
  - タイル: $(-\dfrac{W/2}{256}, 0)$
    - 同じくタイルのy座標は0になる。
  - スクショ: $(w, h)$
- 源スクショの中央(以下「タイル原点」)
  - タイル: $(0, 0)$
  - スクショ: $(W/2 + w, H/2 + h)$
- タイル原点の左下のタイル
  - タイル: $(0, 1)$
  - スクショ: $(W/2 + w - 256, H/2 + h + 128)$
- タイル原点の右下のタイル
  - タイル: $(1, 0)$
  - スクショ: $(W/2 + w + 256, H/2 + h + 128)$
- タイル原点の下に点で接するタイル
  - タイル: $(1, 1)$
  - スクショ: $(W/2 + w, H/2 + h + 256)$
- 源スクショの有効部分の左下、つまり、源スクショ下に有効部分が接する画像(以下「下スクショ」)の有効部分の左上
  - タイル: $(0, \dfrac{H}{128})$
  - スクショ: $(w, H + h)$
- 下スクショの中央
  - タイル: $(\dfrac{H}{256}, \dfrac{H}{256})$
  - スクショ: $(W/2 + w, H + h + H/2)$

## 撮影・照合戦略

条件
- スクショの位置を推定するために、既存のスクショと辺で接するようにする必要があります。
- 誤差を吸収するために、糊代(w, h)を含む必要があります。
- スクショの枚数を増やすと処理が遅くなります。できれば枚数は減らしたいです。
- スクショの範囲を広げると処理が重くなり、各所のsleep秒数を変えないといけなくなって大変です。4Kと同じくらいの画素数にする必要があります。
- マップ全体を撮影する必要があります。
- 撮影の際にはタイル座標は正の値しか指定できません。

ここでの上下左右はスクショ座標系での話です。

スクショの撮影・照合手順
- マップサイズを$(x,y)$として、$x \ge y$の場合
  1. 源スクショ、その下隣、その右隣、その下隣、その右隣...をマップ端まで繰り返す
  2. マップの右端
  3. 1.で得られたスクショから左側を、左端まで
  4. マップの右下の辺と3.の系列の中心線との接点
  5. マップの左端
  6. 3.の最後の行から下側を、下端まで撮影する
  7. マップの下端
- $x \lt y$の場合
  1. 源スクショ、その下隣、その左隣、その下隣、その左隣...をマップ端まで繰り返す
  2. マップの左端
  3. 1.で得られたスクショから右側を、右端まで
  4. マップの左下の辺と3.の系列の中心線との接点
  5. マップの右端
  6. 3.の最後の行から下側を、下端まで撮影する
  7. マップの下端

## 撮影の変数決定

条件
- 照合時ののりしろとして、ある程度ののりしろが必要(1割くらい？)
- 範囲が大きすぎると処理が重くなって色々と問題なので、画素数は4K相当(3840x2160)に近い方が良い
- WとHは1:2の関係を保つ
- スクショ撮影時の中央タイルのタイル座標の差分は、10の倍数や2のべき乗など、キリの良い数値にしたい

Δタイルは40にする。意外と動いた。

撮影するタイル座標の例: (0, 0), (20, 20), (0, 40), (40, 0), ...

- 有効範囲 : 5120x2560
- のりしろ : w=256, h=128 (片側)
- 総サイズ : 5632×2816

すると、UI要素除去用の余裕を考慮すると、

- UI要素除去用の余裕
  - 横: + 256x2 -> 6144
  - 縦: + 64x2 -> 2944
- 総サイズ: 6144x2944

## 地図タイルについて

今回は512x512を利用することにする。

比較
- 256x256
  - 一番よく使われているらしい。
  - タイルが小さい分、アクセス回数が増える。Cloudflare Tunnelを利用する予定なので、1アクセスあたりのオーバーヘッドが大きくなると予想でき、避けたい。
- 512x512
  - タイルが大きい分、余計な部分の画像を取得することは増えるが、アクセス回数を減らすことができる。
