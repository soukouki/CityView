# nginx/webdav.conf
server {
  listen 80;
  server_name _;

  # 200MBまでアップロード可
  client_max_body_size 200m;

  # WebDAV用の一時ファイル置き場（nginxユーザが書ける場所）
  # alpine nginx イメージでは /var/cache/nginx が存在
  client_body_temp_path /var/cache/nginx/client_temp;

  # /images/... を /data/images/... にマップ
  location /images/ {
    alias /data/images/;

    # GET/HEADは通常の静的配信でOK
    autoindex off;

    # WebDAV: PUT/DELETE/MKCOLなどを許可
    dav_methods     PUT DELETE MKCOL COPY MOVE;

    # ディレクトリ自動生成（/images/tiles/{z}/{x}/ などを作れるように）
    create_full_put_path on;

    # パーミッション（作成ファイル/ディレクトリ）
    dav_access user:rw group:rw all:r;

    # CORS（ブラウザから直叩きしない設計でも、将来のデバッグ用に害は少ない）
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Depth, Destination, Overwrite" always;

    # preflight
    if ($request_method = OPTIONS) {
      return 204;
    }
  }

  # ルートはヘルスチェック用に200を返す
  location = / {
    default_type text/plain;
    return 200 "ok\n";
  }
}
