<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simutrans CityView - Map Viewer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MapLibre GL JS -->
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .maplibregl-canvas {
            background-color: #404040;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        .maplibregl-ctrl-compass {
            display: none;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-image {
            max-width: 95vw;
            max-height: calc(100vh - 80px);
            object-fit: contain;
        }
        
        .modal-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .controls {
                top: 6px;
                right: 6px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="controls">
            <!-- Collapsed: Toggle Button -->
            <button
                v-if="!menuOpen"
                @click="menuOpen = true"
                class="bg-white rounded-lg shadow-lg px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
                ☰ {{ currentMap ? currentMap.name : 'Menu' }}
            </button>
            
            <!-- Expanded: Panel -->
            <div v-if="menuOpen" class="bg-white rounded-lg shadow-lg text-sm" style="min-width: 200px; max-width: 260px;">
                <!-- Header -->
                <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200">
                    <span class="font-medium text-gray-700">Menu</span>
                    <button @click="menuOpen = false" class="text-gray-400 hover:text-gray-600">✕</button>
                </div>
                
                <div class="p-3 space-y-3">
                    <!-- Map Selection -->
                    <select
                        v-model="selectedMapId"
                        @change="changeSaveData"
                        class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                        :disabled="maps.length === 0"
                    >
                        <option v-if="maps.length === 0" :value="null">Loading...</option>
                        <option v-for="map in maps" :key="map.map_id" :value="map.map_id">
                            {{ map.name }}
                        </option>
                    </select>
                    
                    <!-- Map Info -->
                    <div v-if="currentMap" class="text-xs text-gray-500 space-y-1">
                        <div v-if="currentMap.description">{{ currentMap.description }}</div>
                        <div class="flex justify-between">
                            <span>Size: {{ currentMap.map_size.x }}×{{ currentMap.map_size.y }}</span>
                            <span v-if="currentMap.copyright">© {{ currentMap.copyright }}</span>
                        </div>
                    </div>
                    
                    <!-- Panels -->
                    <div v-if="currentMap && currentMap.panels && currentMap.panels.length > 0">
                        <div class="text-xs text-gray-500 mb-1">Panels</div>
                        <div class="flex flex-wrap gap-1">
                            <button
                                v-for="panel in currentMap.panels"
                                :key="panel.filename"
                                @click="openModal(panel)"
                                class="px-2 py-1 bg-gray-100 hover:bg-blue-100 border border-gray-200 hover:border-blue-300 rounded text-xs text-gray-600 hover:text-blue-600"
                            >
                                {{ panel.name }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Share -->
                    <button
                        @click="copyShareLink"
                        class="w-full px-2 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                    >
                        {{ shareButtonText }}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div v-if="modalOpen" class="modal" @click="closeModal">
            <img
                ref="modalImage"
                :src="modalImageSrc"
                :alt="modalImageAlt"
                class="modal-image"
                @click.stop
            />
            <div class="modal-bar" @click.stop>
                <button @click="fullscreenImage" class="px-3 py-1.5 bg-gray-700 text-white text-sm rounded hover:bg-gray-600">
                    Fullscreen
                </button>
                <button @click="downloadImage" class="px-3 py-1.5 bg-gray-700 text-white text-sm rounded hover:bg-gray-600">
                    Download
                </button>
                <button @click="closeModal" class="px-3 py-1.5 bg-gray-700 text-white text-sm rounded hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    map: null,
                    maps: [],
                    selectedMapId: null,
                    coordinates: { lng: 0, lat: 0 },
                    tileCoords: { x: 0.5, y: 0.5 },
                    zoom: 0,
                    shareButtonText: 'Share',
                    menuOpen: false,
                    modalOpen: false,
                    modalImageSrc: '',
                    modalImageAlt: '',
                    currentPanel: null
                };
            },
            computed: {
                currentMap() {
                    return this.maps.find(m => m.map_id === this.selectedMapId);
                }
            },
            async mounted() {
                await this.fetchMaps();
                this.parseUrlParams();
                this.initMap();
            },
            methods: {
                async fetchMaps() {
                    try {
                        const response = await fetch('/api/maps');
                        if (!response.ok) throw new Error('Failed to fetch maps');
                        this.maps = await response.json();
                        
                        if (this.maps.length > 0 && this.selectedMapId === null) {
                            this.selectedMapId = this.maps[0].map_id;
                        }
                    } catch (error) {
                        console.error('Failed to fetch maps:', error);
                        this.maps = [];
                    }
                },
                
                lngLatToTile(lng, lat, zoom) {
                    const n = Math.pow(2, zoom);
                    const x = ((lng + 180) / 360) * n;
                    const latRad = lat * Math.PI / 180;
                    const y = (1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n;
                    return { x, y };
                },
                
                tileToLngLat(x, y, zoom) {
                    const n = Math.pow(2, zoom);
                    const lng = (x / n) * 360 - 180;
                    const latRad = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n)));
                    const lat = latRad * 180 / Math.PI;
                    return { lng, lat };
                },
                
                parseUrlParams() {
                    const params = new URLSearchParams(window.location.search);
                    const mapId = params.get('map');
                    const z = params.get('z');
                    const x = params.get('x');
                    const y = params.get('y');
                    
                    if (mapId) {
                        const id = parseInt(mapId, 10);
                        if (this.maps.some(m => m.map_id === id)) {
                            this.selectedMapId = id;
                        }
                    }
                    
                    if (z !== null && x !== null && y !== null) {
                        this.zoom = parseFloat(z);
                        const tileX = parseFloat(x);
                        const tileY = parseFloat(y);
                        this.tileCoords = { x: tileX, y: tileY };
                        const lngLat = this.tileToLngLat(tileX, tileY, this.zoom);
                        this.coordinates = lngLat;
                    } else {
                        this.zoom = 0;
                        this.tileCoords = { x: 0.5, y: 0.5 };
                        this.coordinates = { lng: 0, lat: 0 };
                    }
                },
                
                initMap() {
                    if (this.selectedMapId === null) return;
                    
                    this.map = new maplibregl.Map({
                        container: 'map',
                        style: {
                            version: 8,
                            sources: {
                                'raster-tiles': {
                                    type: 'raster',
                                    tiles: [
                                        `/tiles/${this.selectedMapId}/{z}/{x}/{y}.avif`
                                    ],
                                    tileSize: 512
                                }
                            },
                            layers: [{
                                id: 'simple-tiles',
                                type: 'raster',
                                source: 'raster-tiles'
                            }]
                        },
                        center: [this.coordinates.lng, this.coordinates.lat],
                        zoom: this.zoom,
                        renderWorldCopies: false,
                        dragRotate: false,
                        pitchWithRotate: false,
                        touchPitch: false
                    });

                    this.map.on('load', () => {
                        this.map.touchZoomRotate.disableRotation();
                    });

                    this.map.on('error', (e) => {
                        if (e.error && (
                            e.error.status === 404 || 
                            e.error.message?.includes('Could not load image') ||
                            e.error.message?.includes('AJAXError')
                        )) {
                            return;
                        }
                        console.error('Map error:', e);
                    });

                    this.map.addControl(new maplibregl.NavigationControl({
                        showCompass: false,
                        showZoom: true
                    }), 'bottom-right');

                    this.map.on('moveend', () => {
                        this.updateCoordinates();
                        this.updateUrl();
                    });

                    this.updateCoordinates();
                },
                
                updateCoordinates() {
                    if (this.map) {
                        const center = this.map.getCenter();
                        this.coordinates = { lng: center.lng, lat: center.lat };
                        this.zoom = this.map.getZoom();
                        this.tileCoords = this.lngLatToTile(center.lng, center.lat, this.zoom);
                    }
                },
                
                updateUrl() {
                    const params = new URLSearchParams();
                    params.set('map', this.selectedMapId);
                    params.set('z', this.zoom.toFixed(2));
                    params.set('x', this.tileCoords.x.toFixed(4));
                    params.set('y', this.tileCoords.y.toFixed(4));
                    
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.replaceState({}, '', newUrl);
                },
                
                changeSaveData() {
                    if (this.map) {
                        this.map.remove();
                    }
                    this.initMap();
                    this.updateUrl();
                },
                
                copyShareLink() {
                    const url = window.location.href;
                    navigator.clipboard?.writeText(url).then(() => {
                        this.shareButtonText = 'Copied!';
                        setTimeout(() => { this.shareButtonText = 'Share'; }, 2000);
                    }).catch(() => {
                        this.shareButtonText = 'Failed';
                        setTimeout(() => { this.shareButtonText = 'Share'; }, 2000);
                    });
                },
                
                openModal(panel) {
                    this.currentPanel = panel;
                    this.modalImageSrc = `/panels/${this.selectedMapId}/${panel.filename}`;
                    this.modalImageAlt = panel.name;
                    this.modalOpen = true;
                },
                
                closeModal() {
                    this.modalOpen = false;
                    this.currentPanel = null;
                },
                
                downloadImage() {
                    if (!this.currentPanel) return;
                    const link = document.createElement('a');
                    link.href = this.modalImageSrc;
                    link.download = this.currentPanel.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                
                fullscreenImage() {
                    const img = this.$refs.modalImage;
                    if (img?.requestFullscreen) img.requestFullscreen();
                    else if (img?.webkitRequestFullscreen) img.webkitRequestFullscreen();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
