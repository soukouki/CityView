events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    # AVIFのMIMEタイプを追加
    types {
        image/avif avif;
    }

    resolver 127.0.0.11 valid=30s;

    upstream backend_app {
        server 127.0.0.1:4567;
    }

    # 環境変数からStorageホストを取得（デフォルト: storage）
    map $http_host $storage_host {
        default "${STORAGE_HOST}";
    }

    server {
        listen 8000;
        server_name _;

        # 静的ファイルの配信
        location / {
            root /app/public;
            try_files $uri $uri/ /index.html;
        }

        # タイル配信（storageへプロキシ）
        location ~ ^/tiles/([^/]+)/(.*)$ {
            # $1 = save_data_name (例: demo)
            # $2 = z/x/y.avif (例: 0/0/0.avif)
            
            set $save_data_name $1;
            set $tile_path $2;
            
            # 環境変数を使用してStorageホストを指定
            set $storage_url "${STORAGE_HOST}";
            
            proxy_pass http://$storage_url:80/images/tiles/$save_data_name/$tile_path;
            proxy_set_header Host $storage_url;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # キャッシュヘッダー
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        # API エンドポイント
        location /api/ {
            proxy_pass http://backend_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ヘルスチェック
        location /health {
            proxy_pass http://backend_app;
        }
    }
}
