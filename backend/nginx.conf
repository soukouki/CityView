events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    # AVIFのMIMEタイプを追加
    types {
        image/avif avif;
    }

    # ログ設定（エラーを記録しない）
    map $status $loggable {
        ~^[45]  0;
        default 1;
    }

    access_log /var/log/nginx/access.log combined if=$loggable;
    error_log /var/log/nginx/error.log warn;

    upstream backend_main {
        server backend:4567;
    }

    upstream backend_admin {
        server backend:4568;
    }

    upstream storage_backend {
        server storage:80;
    }

    # ========================================
    # メイン画面（ポート8000）
    # ========================================
    server {
        listen 8000;
        server_name _;

        # 静的ファイルの配信
        location / {
            root /app/public;
            try_files $uri $uri/ /index.html;
        }

        # タイル配信（storageへプロキシ、404を透過的に処理）
        location ~ ^/tiles/([^/]+)/(.*)$ {
            set $map_id $1;
            set $tile_path $2;
            
            # storageへプロキシ
            proxy_pass http://storage_backend/images/tiles/$map_id/$tile_path;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # タイムアウト設定
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            
            # 404とゲートウェイエラーを透過的に処理
            proxy_intercept_errors on;
            error_page 404 502 503 504 = @empty_tile;
            
            # キャッシュヘッダー
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        # パネル配信 (storageへプロキシ、404は普通に404を返す)
        location ~ ^/panels/([^/]+)/(.*)$ {
            set $map_id $1;
            set $panel_path $2;
            
            # storageへプロキシ
            proxy_pass http://storage_backend/images/panels/$map_id/$panel_path;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # タイムアウト設定
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            
            # キャッシュヘッダー
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        # 空のタイルを返す（エラー時）
        location @empty_tile {
            internal;
            # 204 No Contentを返す（ブラウザは空として扱う）
            return 204;
        }

        # APIエンドポイント
        location /api/ {
            proxy_pass http://backend_main;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ヘルスチェック
        location /health {
            proxy_pass http://backend_main;
        }
    }

    # ========================================
    # 管理画面（ポート8001）
    # ========================================
    server {
        listen 8001;
        server_name _;

        # 静的ファイルの配信
        location / {
            root /app/admin;
            try_files $uri $uri/ /index.html;
        }

        # APIエンドポイント
        location /api/ {
            proxy_pass http://backend_admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
