#!/usr/bin/env bash
set -euo pipefail

OUT=".env"

#---------------------------------------
# ユーザー向け入力欄ここから
#---------------------------------------

TZ="Asia/Tokyo"

# paksetについて
PAKSET_NAME="Pak128.Britain-Ex"
PAKSIZE=128

# マップの大きさについて
# demo1
# MAP_TILES_X=512
# MAP_TILES_Y=32
# demo2
MAP_TILES_X=4384
MAP_TILES_Y=5040

# 撮影時のズームレベル
# one_eighth : 0.125倍、6段階縮小、最大ズームアウト
# quarter    : 0.25倍、5段階縮小
# half       : 0.5倍、3段階縮小
# normal     : 1倍、標準
# double     : 2倍、3段階拡大、最大ズームイン
ZOOM_LEVEL=one_eighth

# 地図タイルについて
TILE_SIZE=512
TILE_QUALITY_MAX_ZOOM=lossless # losslessまたは0〜100の整数
TILE_QUALITY_OTHER=lossless

# 地図タイルのグループサイズ
# 小さくするとタスクグループが小さくなりタイル処理に関わる並列数が上がるが、タスクオーケストレータが重くなる
# 巨大なマップ(4000x5000とか)でdoubleズームで撮るなら大きめ(64とか)が良い
# マップが小さい/ズームレベルが縮小側/並列数を上げたい場合は小さめ(8とか)が良い
TILE_GROUP_SIZE=16

# スクショ撮影について
# 推奨値 : quarter=320, half=160, normal=80, double=40
# メモリが足りない場合は小さくする
DELTA=320

#---------------------------------------
# ユーザー向け入力欄ここまで
# 設定後は./env-genを実行して.envを生成するのをお忘れなく！(n敗)
# 反映する際にはsudo docker-compose down / sudo docker-compose up -dを実行してコンテナを作り直してください
#---------------------------------------

CROP_OFFSET_Y=64   # メニューバー分

# 補正後PAKSIZE
case $ZOOM_LEVEL in
  one_eighth)
    ADJUSTED_PAKSIZE=$(( PAKSIZE / 8 ))
    ;;
  quarter)
    ADJUSTED_PAKSIZE=$(( PAKSIZE / 4 ))
    ;;
  half)
    ADJUSTED_PAKSIZE=$(( PAKSIZE / 2 ))
    ;;
  normal)
    ADJUSTED_PAKSIZE=$(( PAKSIZE ))
    ;;
  double)
    ADJUSTED_PAKSIZE=$(( PAKSIZE * 2 ))
    ;;
  *)
    echo "Unknown ZOOM_LEVEL: $ZOOM_LEVEL"
    exit 1
    ;;
esac

# マウスカーソル待避のために1タイルの横幅分
CROP_OFFSET_X=$(( ADJUSTED_PAKSIZE ))

# 塗りしろは2タイル分(1タイルにしたら足りなかった)
IMAGE_MARGIN_WIDTH=$(( ADJUSTED_PAKSIZE * 2 ))

# 縦なのでPAKSIZEの半分、が2タイル分なのでPAKSIZEと同じ
IMAGE_MARGIN_HEIGHT=$(( ADJUSTED_PAKSIZE ))

# 糊代を含めたスクショ画像サイズ
IMAGE_WIDTH=$(( DELTA * ADJUSTED_PAKSIZE + IMAGE_MARGIN_WIDTH * 2 ))
IMAGE_HEIGHT=$(( DELTA * ADJUSTED_PAKSIZE / 2 + IMAGE_MARGIN_HEIGHT * 2 ))

CAPTURE_WIDTH=$(( IMAGE_WIDTH + CROP_OFFSET_X * 2 ))
CAPTURE_HEIGHT=$(( IMAGE_HEIGHT + CROP_OFFSET_Y * 2 ))

cat > "$OUT" <<EOF
# サービスの設定

TZ=$TZ

# paksetについて
PAKSET_NAME=$PAKSET_NAME
PAKSIZE=$PAKSIZE

# マップの大きさについて
MAP_TILES_X=$MAP_TILES_X
MAP_TILES_Y=$MAP_TILES_Y

# 地図タイルについて
TILE_SIZE=$TILE_SIZE
TILE_QUALITY_MAX_ZOOM=$TILE_QUALITY_MAX_ZOOM
TILE_QUALITY_OTHER=$TILE_QUALITY_OTHER
TILE_GROUP_SIZE=$TILE_GROUP_SIZE

# スクショ撮影について
DELTA=$DELTA
CROP_OFFSET_X=$CROP_OFFSET_X
CROP_OFFSET_Y=$CROP_OFFSET_Y
IMAGE_MARGIN_WIDTH=$IMAGE_MARGIN_WIDTH
IMAGE_MARGIN_HEIGHT=$IMAGE_MARGIN_HEIGHT
IMAGE_WIDTH=$IMAGE_WIDTH
IMAGE_HEIGHT=$IMAGE_HEIGHT
CAPTURE_WIDTH=$CAPTURE_WIDTH
CAPTURE_HEIGHT=$CAPTURE_HEIGHT
ADJUSTED_PAKSIZE=$ADJUSTED_PAKSIZE
ZOOM_LEVEL=$ZOOM_LEVEL
EOF

echo "✔ .env generated ($OUT)"
