#!/usr/bin/env bash
set -euo pipefail

OUT=".env"

#---------------------------------------
# ユーザー向け入力欄ここから
# 設定後は./env-genを実行して.envを生成するのをお忘れなく！(n敗)
#---------------------------------------

TZ="Asia/Tokyo"

# マップについて
# SIMUTRANS_EXECUTABLE="nanasaba/simutrans-extended"
# SIMUTRANS_EXECUTABLE="yokoze/sim-linux-OTRPv47_3_3"
SIMUTRANS_EXECUTABLE="kumagaya/sim-linux-OTRPv47_3_3" # どうせ互換性はあるのでこれで良いや
# SIMUTRANS_EXECUTABLE="npns-e1/sim-linux-OTRPv44_5_1"
# PAKSET_NAME="Pak128.Britain-Ex"
# PAKSET_NAME="pak128"
PAKSET_NAME="pak128_kuma"
# PAKSET_NAME="pak.NPNDv0_06"
PAKSIZE=128
# PAKSIZE=64
# SAVE_DATA_NAME="demo1"
# SAVE_DATA_NAME="yokoze-last"
SAVE_DATA_NAME="kumagaya-last"
# SAVE_DATA_NAME="npns-e1-2029"

# マップの大きさについて
# Pak128.Britain-Exのサンプルマップ
# MAP_TILES_X=512
# MAP_TILES_Y=32
# ななさば1期
# MAP_TILES_X=4384
# MAP_TILES_Y=5040
# 横瀬
# MAP_TILES_X=1920
# MAP_TILES_Y=1280
# 熊谷
MAP_TILES_X=1280
MAP_TILES_Y=640
# NPNS-E1
# MAP_TILES_X=2529
# MAP_TILES_Y=2484

# 撮影時のズームレベル
# one_eighth : 0.125倍、6段階縮小、最大ズームアウト
# quarter    : 0.25倍、5段階縮小
# half       : 0.5倍、3段階縮小
# normal     : 1倍、標準
# double     : 2倍、3段階拡大、最大ズームイン
ZOOM_LEVEL=half

# 地図タイルについて
TILE_SIZE=512
TILE_QUALITY_MAX_ZOOM=lossless # losslessまたは0〜100の整数
TILE_QUALITY_OTHER=lossless

# 地図タイルのグループサイズ
# 小さくするとタスクグループが小さくなりタイル処理に関わる並列数が上がるが、タスクオーケストレータが重くなる
# 巨大なマップ(4000x5000とか)でdoubleズームで撮るなら大きめ(64とか)が良い
# マップが小さい/ズームレベルが縮小側/並列数を上げたい場合は小さめ(8とか)が良い
TILE_GROUP_SIZE=16

# スクショ撮影について
# 推奨値 : one_eighth=800, quarter=400, half=200, normal=100, double=50
# メモリが足りない場合は小さくする
DELTA=200

# スクショの糊代の大きさ(%)
# 5にすると、上下左右それぞれ画像サイズの5%分が糊代になる
# 基本は3%や5%で十分だが、山がちで地形が激しい場合は10%くらいにしても良い
# 急坂など、一部のケースではなかなか推定が安定しない場合は25%くらいにしても良い
# ズームして撮影する場合は2タイル分と比べて大きい方を採用する
IMAGE_MERGIN_RATIO_PERCENT=20

# 再描画待ち時間(秒)
# 横瀬マップのように開発が極端に進んでいて、quarterやone_eighthで撮影する場合は1.0秒くらいにした方が良い
# そこまで開発が進んでいなかったり、ズームイン側で撮影する場合は0.2秒くらいで十分
CAPTURE_REDRAW_WAIT_SECONDS=3.0

#---------------------------------------
# ユーザー向け入力欄ここまで
# 設定後は./env-genを実行して.envを生成するのをお忘れなく！(n敗)
# 反映する際にはsudo docker-compose down / sudo docker-compose up -dを実行してコンテナを作り直してください
#---------------------------------------

CROP_OFFSET_Y=64   # メニューバー分

# 補正後PAKSIZE
case $ZOOM_LEVEL in
  one_eighth)
    ADJUSTED_PAKSIZE=$(( PAKSIZE / 8 ))
    ;;
  quarter)
    ADJUSTED_PAKSIZE=$(( PAKSIZE / 4 ))
    ;;
  half)
    ADJUSTED_PAKSIZE=$(( PAKSIZE / 2 ))
    ;;
  normal)
    ADJUSTED_PAKSIZE=$(( PAKSIZE ))
    ;;
  double)
    ADJUSTED_PAKSIZE=$(( PAKSIZE * 2 ))
    ;;
  *)
    echo "Unknown ZOOM_LEVEL: $ZOOM_LEVEL"
    exit 1
    ;;
esac

# マウスカーソル待避のために1タイルの横幅分
CROP_OFFSET_X=$(( ADJUSTED_PAKSIZE ))

# 実質的なスクショの有効範囲
IMAGE_EFFECTIVE_WIDTH=$(( DELTA * ADJUSTED_PAKSIZE / 2 ))
IMAGE_EFFECTIVE_HEIGHT=$(( DELTA * ADJUSTED_PAKSIZE / 4 ))

# タイル数だと縮小時に塗りしろが小さくなり、割合だと拡大時に塗りしろが小さくなってしまった。なので、タイル数と割合の大きい方を採用するようにした
IMAGE_MARGIN_RATIO_WIDTH=$(( IMAGE_EFFECTIVE_WIDTH * IMAGE_MERGIN_RATIO_PERCENT / 100 ))
IMAGE_MARGIN_RATIO_HEIGHT=$(( IMAGE_EFFECTIVE_HEIGHT * IMAGE_MERGIN_RATIO_PERCENT / 100 ))
IMAGE_MARGIN_TILE_WIDTH=$(( ADJUSTED_PAKSIZE * 2 )) # 2タイル分
IMAGE_MARGIN_TILE_HEIGHT=$(( ADJUSTED_PAKSIZE )) # 2タイル分
if [ $IMAGE_MARGIN_RATIO_WIDTH -gt $IMAGE_MARGIN_TILE_WIDTH ]; then
  IMAGE_MARGIN_WIDTH=$IMAGE_MARGIN_RATIO_WIDTH
else
  IMAGE_MARGIN_WIDTH=$IMAGE_MARGIN_TILE_WIDTH
fi
if [ $IMAGE_MARGIN_RATIO_HEIGHT -gt $IMAGE_MARGIN_TILE_HEIGHT ]; then
  IMAGE_MARGIN_HEIGHT=$IMAGE_MARGIN_RATIO_HEIGHT
else
  IMAGE_MARGIN_HEIGHT=$IMAGE_MARGIN_TILE_HEIGHT
fi

# 糊代を含めたスクショ画像サイズ
IMAGE_WIDTH=$(( IMAGE_EFFECTIVE_WIDTH + IMAGE_MARGIN_WIDTH * 2 ))
IMAGE_HEIGHT=$(( IMAGE_EFFECTIVE_HEIGHT + IMAGE_MARGIN_HEIGHT * 2 ))

CAPTURE_WIDTH=$(( IMAGE_WIDTH + CROP_OFFSET_X * 2 ))
CAPTURE_HEIGHT=$(( IMAGE_HEIGHT + CROP_OFFSET_Y * 2 ))

cat > "$OUT" <<EOF
# サービスの設定

TZ=$TZ

# マップについて
SIMUTRANS_EXECUTABLE=$SIMUTRANS_EXECUTABLE
PAKSET_NAME=$PAKSET_NAME
PAKSIZE=$PAKSIZE
SAVE_DATA_NAME=$SAVE_DATA_NAME

# マップの大きさについて
MAP_TILES_X=$MAP_TILES_X
MAP_TILES_Y=$MAP_TILES_Y

# 地図タイルについて
TILE_SIZE=$TILE_SIZE
TILE_QUALITY_MAX_ZOOM=$TILE_QUALITY_MAX_ZOOM
TILE_QUALITY_OTHER=$TILE_QUALITY_OTHER
TILE_GROUP_SIZE=$TILE_GROUP_SIZE

# スクショ撮影について
DELTA=$DELTA
CROP_OFFSET_X=$CROP_OFFSET_X
CROP_OFFSET_Y=$CROP_OFFSET_Y
IMAGE_MARGIN_WIDTH=$IMAGE_MARGIN_WIDTH
IMAGE_MARGIN_HEIGHT=$IMAGE_MARGIN_HEIGHT
IMAGE_EFFECTIVE_WIDTH=$IMAGE_EFFECTIVE_WIDTH
IMAGE_EFFECTIVE_HEIGHT=$IMAGE_EFFECTIVE_HEIGHT
IMAGE_WIDTH=$IMAGE_WIDTH
IMAGE_HEIGHT=$IMAGE_HEIGHT
CAPTURE_WIDTH=$CAPTURE_WIDTH
CAPTURE_HEIGHT=$CAPTURE_HEIGHT
ADJUSTED_PAKSIZE=$ADJUSTED_PAKSIZE
ZOOM_LEVEL=$ZOOM_LEVEL
CAPTURE_REDRAW_WAIT_SECONDS=$CAPTURE_REDRAW_WAIT_SECONDS
EOF

echo "✔ .env generated ($OUT)"
